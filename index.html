<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Food Tracker</title>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      color: #333;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: #121212;
      color: #ddd;
    }
    header {
      background: linear-gradient(90deg, #4b6cb7, #182848);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
    }
    header .nav-buttons button {
      background: transparent;
      border: 2px solid white;
      color: white;
      margin-left: 10px;
      padding: 6px 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
    }
    header .nav-buttons button:hover {
      background: white;
      color: #182848;
    }
    main {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    section.hidden {
      display: none;
    }
    form {
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
      gap: 15px;
      align-items: end;
    }
    form label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      font-size: 0.9rem;
    }
    form input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    form input:focus {
      border-color: #4b6cb7;
      outline: none;
    }
    form button {
      background: #4b6cb7;
      color: white;
      border: none;
      padding: 10px 18px;
      font-weight: 700;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      grid-column: span 1;
      justify-self: start;
    }
    form button:hover {
      background: #182848;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    }
    th, td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 0.95rem;
    }
    th {
      background: #4b6cb7;
      color: white;
      user-select: none;
    }
    tr.expired {
      background-color: #f8d7da;
      color: #721c24;
    }
    tr.expiring {
      background-color: #fff3cd;
      color: #856404;
    }
    button.edit-btn,
    button.delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 4px;
      margin-right: 5px;
      transition: background-color 0.2s;
    }
    button.edit-btn {
      color: #007bff;
    }
    button.edit-btn:hover {
      background-color: rgba(0,123,255,0.15);
    }
    button.delete-btn {
      color: #dc3545;
    }
    button.delete-btn:hover {
      background-color: rgba(220,53,69,0.15);
    }
    #exportAlimentiBtn {
      margin-top: 15px;
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 16px;
      font-weight: 700;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #exportAlimentiBtn:hover {
      background: #19692c;
    }
    #themeToggle {
      background: #ffc107;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 700;
      color: #212529;
      transition: background-color 0.3s;
    }
    #themeToggle:hover {
      background: #e0a800;
    }
    @media (max-width: 600px) {
      form {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      header .nav-buttons {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Food Tracker</h1>
    <div>
      <button id="themeToggle">Toggle Dark Mode</button>
      <div class="nav-buttons" style="display:inline-block; margin-left:20px;">
        <button id="alimentiBtn">Alimenti</button>
        <button id="temperatureBtn">Temperature</button>
      </div>
    </div>
  </header>
  <main>
    <section id="alimentiSection">
      <form id="foodForm">
        <label>
          Data
          <input type="date" name="data" required />
        </label>
        <label>
          Prodotto
          <input type="text" name="prodotto" required />
        </label>
        <label>
          Quantità
          <input type="number" name="quantita" min="0" step="1" />
        </label>
        <label>
          Processo
          <input type="text" name="processo" />
        </label>
        <label>
          Scadenza
          <input type="date" name="scadenza" required />
        </label>
        <button type="submit">Aggiungi</button>
      </form>

      <table id="foodTable" aria-label="Elenco alimenti">
        <thead>
          <tr>
            <th>Data</th>
            <th>Prodotto</th>
            <th>Quantità</th>
            <th>Processo</th>
            <th>Scadenza</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="exportAlimentiBtn">Esporta PDF</button>
    </section>

    <section id="temperatureSection" class="hidden">
      <h2>Sezione Temperature (in costruzione)</h2>
      <p>Qui sarà visualizzato il monitoraggio temperature.</p>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- jsPDF + AutoTable for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Paste the full app.js logic here (below)
    
    // Firebase config - REPLACE with your Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyAVmsiSzszfgCEk5qqnX57pGigoQtUafAU",
      authDomain: "food-tracker-fca47.firebaseapp.com",
      projectId: "food-tracker-fca47",
      storageBucket: "food-tracker-fca47.firebasestorage.app",
      messagingSenderId: "769456892190",
      appId: "1:769456892190:web:9c2a2e7d676f1f2d85010f"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM Elements
    const alimentiSection = document.getElementById('alimentiSection');
    const foodForm = document.getElementById('foodForm');
    const foodTableBody = document.querySelector('#foodTable tbody');
    const exportAlimentiBtn = document.getElementById('exportAlimentiBtn');

    const alimentiBtn = document.getElementById('alimentiBtn');
    const temperatureBtn = document.getElementById('temperatureBtn');
    const temperatureSection = document.getElementById('temperatureSection');

    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;

    let editingId = null;

    function formatDate(dateStr){
      if(!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('it-IT');
    }

    function resetForm(){
      foodForm.reset();
      editingId = null;
      foodForm.querySelector('button[type=submit]').textContent = 'Aggiungi';
    }

    function renderItems(items){
      const now = new Date();
      const msInDay = 24*60*60*1000;

      // Sort: expired first, then expiring soon, then fresh
      items.sort((a,b) => {
        const aExp = new Date(a.scadenza);
        const bExp = new Date(b.scadenza);
        const aDiff = aExp - now;
        const bDiff = bExp - now;

        function priority(diff) {
          if(diff < 0) return 0;       // expired highest priority
          else if(diff <= msInDay) return 1; // expiring soon
          return 2;                    // fresh
        }
        const prioA = priority(aDiff);
        const prioB = priority(bDiff);

        if(prioA !== prioB) return prioA - prioB;
        return aExp - bExp;
      });

      foodTableBody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        const expiry = new Date(item.scadenza);
        const diff = expiry - now;

        if(diff < 0){
          tr.classList.add('expired');
        } else if(diff <= msInDay){
          tr.classList.add('expiring');
        }

        tr.innerHTML = `
          <td>${formatDate(item.data)}</td>
          <td>${item.prodotto}</td>
          <td>${item.quantita || ''}</td>
          <td>${item.processo || ''}</td>
          <td>${formatDate(item.scadenza)}</td>
          <td>
            <button class="edit-btn" data-id="${item.id}">Modifica</button>
            <button class="delete-btn" data-id="${item.id}">Elimina</button>
          </td>
        `;
        foodTableBody.appendChild(tr);
      });

      // Add event listeners for edit and delete buttons
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = () => startEdit(btn.dataset.id);
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => {
          if(confirm('Sei sicuro di voler eliminare questo elemento?')){
            db.collection('items').doc(btn.dataset.id).delete();
          }
        }
      });
    }

    function startEdit(id){
      db.collection('items').doc(id).get().then(doc => {
        if(doc.exists){
          const data = doc.data();
          editingId = id;
          foodForm.data.value = data.data;
          foodForm.prodotto.value = data.prodotto;
          foodForm.quantita.value = data.quantita || '';
          foodForm.processo.value = data.processo || '';
          foodForm.scadenza.value = data.scadenza;
          foodForm.querySelector('button[type=submit]').textContent = 'Salva';
        }
      });
    }

    // Load items and listen for changes realtime
    db.collection('items').onSnapshot(snapshot => {
      const items = [];
      snapshot.forEach(doc => {
        items.push({id: doc.id, ...doc.data()});
      });
      renderItems(items);
    });

    // Handle form submit
    foodForm.addEventListener('submit', e => {
      e.preventDefault();
      const newItem = {
        data: foodForm.data.value,
        prodotto: foodForm.prodotto.value.trim(),
        quantita: foodForm.quantita.value.trim(),
        processo: foodForm.processo.value.trim(),
        scadenza: foodForm.scadenza.value
      };

      if(editingId){
        db.collection('items').doc(editingId).update(newItem).then(() => {
          resetForm();
        });
      } else {
        db.collection('items').add(newItem).then(() => {
          resetForm();
        });
      }
    });

    // Export PDF for Alimenti
    exportAlimentiBtn.onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text('Elenco Alimenti', 14, 20);

      const rows = [];
      foodTableBody.querySelectorAll('tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => {
          if(td.textContent) row.push(td.textContent.trim());
        });
        if(row.length) rows.push(row);
      });

      doc.autoTable({
        head: [['Data', 'Prodotto', 'Quantità', 'Processo', 'Scadenza']],
        body: rows,
        startY: 30
      });

      doc.save('elenco-alimenti.pdf');
    };

    // Toggle sections
    alimentiBtn.onclick = () => {
      alimentiSection.class
