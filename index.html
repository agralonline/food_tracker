<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Food Tracker</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <header>
    <div>
      <button id="alimentiBtn">Alimenti</button>
      <button id="temperatureBtn">Temperature</button>
    </div>
    <button id="themeToggle">üåì</button>
  </header>

  <section id="alimentiSection">
    <form id="foodForm">
      <input type="date" name="data" required>
      <input type="text" name="prodotto" placeholder="Prodotto" required>
      <input type="number" name="quantita" placeholder="Quantit√†">
      
      <select name="processo" required>
        <option value="">Seleziona Processo</option>
        <option value="Abbatutto -18¬∞ C">Abbatutto -18¬∞ C</option>
        <option value="Abbatutto +3¬∞ C">Abbatutto +3¬∞ C</option>
        <option value="Decongelato">Decongelato</option>
      </select>

      <input type="date" name="scadenza" required>

      <select name="sottovuoto" required>
        <option value="">Sottovuoto?</option>
        <option value="S√¨">S√¨</option>
        <option value="No">No</option>
      </select>

      <button type="submit">Aggiungi</button>
    </form>

    <table id="foodTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Prodotto</th>
          <th>Quantit√†</th>
          <th>Processo</th>
          <th>Scadenza</th>
          <th>Sottovuoto</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="legend">
      <span class="legend-box expired"></span> Scaduti
      <span class="legend-box expiring" style="margin-left:1rem;"></span> In Scadenza
    </div>

    <button id="exportAlimentiBtn">üìÑ Esporta PDF</button>
  </section>

  <section id="temperatureSection" class="hidden">
    <h2>Temperature - In Arrivo</h2>
  </section>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAVmsiSzszfgCEk5qqnX57pGigoQtUafAU",
      authDomain: "food-tracker-fca47.firebaseapp.com",
      projectId: "food-tracker-fca47",
      storageBucket: "food-tracker-fca47.firebasestorage.app",
      messagingSenderId: "769456892190",
      appId: "1:769456892190:web:9c2a2e7d676f1f2d85010f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const alimentiSection = document.getElementById('alimentiSection');
    const temperatureSection = document.getElementById('temperatureSection');
    const foodForm = document.getElementById('foodForm');
    const foodTableBody = document.querySelector('#foodTable tbody');
    const exportAlimentiBtn = document.getElementById('exportAlimentiBtn');
    const alimentiBtn = document.getElementById('alimentiBtn');
    const temperatureBtn = document.getElementById('temperatureBtn');
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;

    let editingId = null;

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('it-IT');
    }

    function resetForm() {
      foodForm.reset();
      editingId = null;
      foodForm.querySelector('button[type=submit]').textContent = 'Aggiungi';
    }

    function renderItems(items) {
      const now = new Date();
      const msInDay = 24 * 60 * 60 * 1000;

      items.sort((a, b) => {
        const aExp = new Date(a.scadenza);
        const bExp = new Date(b.scadenza);
        const prio = diff => diff < 0 ? 0 : diff <= msInDay ? 1 : 2;
        return prio(aExp - now) - prio(bExp - now) || aExp - bExp;
      });

      foodTableBody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        const diff = new Date(item.scadenza) - now;

        if (diff < 0) tr.classList.add('expired');
        else if (diff <= msInDay) tr.classList.add('expiring');

        tr.innerHTML = `
          <td>${formatDate(item.data)}</td>
          <td>${item.prodotto}</td>
          <td>${item.quantita || ''}</td>
          <td>${item.processo || ''}</td>
          <td>${formatDate(item.scadenza)}</td>
          <td>${item.sottovuoto || ''}</td>
          <td>
            <button class="edit-btn" data-id="${item.id}">‚úèÔ∏è</button>
            <button class="delete-btn" data-id="${item.id}">üóëÔ∏è</button>
          </td>
        `;
        foodTableBody.appendChild(tr);
      });

      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = () => startEdit(btn.dataset.id);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        if (confirm('Sei sicuro di voler eliminare questo elemento?')) {
          btn.onclick = () => db.collection('items').doc(btn.dataset.id).delete();
        }
      });
    }

    function startEdit(id) {
      db.collection('items').doc(id).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          editingId = id;
          foodForm.data.value = data.data;
          foodForm.prodotto.value = data.prodotto;
          foodForm.quantita.value = data.quantita || '';
          foodForm.processo.value = data.processo || '';
          foodForm.scadenza.value = data.scadenza;
          foodForm.sottovuoto.value = data.sottovuoto || '';
          foodForm.querySelector('button[type=submit]').textContent = 'Salva';
        }
      });
    }

    db.collection('items').onSnapshot(snapshot => {
      const items = [];
      snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
      renderItems(items);
    });

    foodForm.addEventListener('submit', e => {
      e.preventDefault();
      const newItem = {
        data: foodForm.data.value,
        prodotto: foodForm.prodotto.value.trim(),
        quantita: foodForm.quantita.value.trim(),
        processo: foodForm.processo.value,
        scadenza: foodForm.scadenza.value,
        sottovuoto: foodForm.sottovuoto.value
      };

      if (!newItem.sottovuoto || !newItem.processo) {
        alert("Seleziona un'opzione per 'Processo' e 'Sottovuoto'");
        return;
      }

      if (editingId) {
        db.collection('items').doc(editingId).update(newItem).then(resetForm);
      } else {
        db.collection('items').add(newItem).then(resetForm);
      }
    });

    exportAlimentiBtn.onclick = () => {
      import('jspdf').then(jsPDFModule => {
        const { jsPDF } = jsPDFModule;
        const doc = new jsPDF();
        doc.text('Elenco Alimenti', 14, 20);
        const rows = [];
        foodTableBody.querySelectorAll('tr').forEach(tr => {
          const row = [];
          tr.querySelectorAll('td').forEach(td => row.push(td.textContent.trim()));
          if (row.length) rows.push(row);
        });

        doc.autoTable({
          head: [['Data', 'Prodotto', 'Quantit√†', 'Processo', 'Scadenza', 'Sottovuoto']],
          body: rows,
          startY: 30
        });

        doc.save('elenco-alimenti.pdf');
      });
    };

    alimentiBtn.onclick = () => {
      alimentiSection.classList.remove('hidden');
      temperatureSection.classList.add('hidden');
    };

    temperatureBtn.onclick = () => {
      alimentiSection.classList.add('hidden');
      temperatureSection.classList.remove('hidden');
    };

    themeToggle.onclick = () => {
      body.classList.toggle('dark-mode');
      localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light');
    };

    if (localStorage.getItem('theme') === 'dark') {
      body.classList.add('dark-mode');
    }
  </script>
</body>
</html>
